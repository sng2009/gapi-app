import streamlit as st
from openai import OpenAI
import random

# --- í˜ì´ì§€ ì„¤ì • ---
st.set_page_config(
    page_title="AI ëë§ì‡ê¸° (ê·œì¹™ ì„ íƒ)",
    page_icon="ğŸ‘‘"
)

# --- ì•± ì œëª© ë° ì„¤ëª… ---
st.title("ğŸ‘‘ AI ëë§ì‡ê¸° ê²Œì„ (ê·œì¹™ ì„ íƒ ê°€ëŠ¥)")
st.markdown("""
í”Œë ˆì´í•˜ê³  ì‹¶ì€ ëë§ì‡ê¸° ê·œì¹™ì„ ì§ì ‘ ì„ íƒí•˜ê³  AIì™€ ëŒ€ê²°í•´ ë³´ì„¸ìš”!  
**ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ê·œì¹™ì„ ì„ íƒí•˜ê³  OpenAI API í‚¤ë¥¼ ì…ë ¥**í•˜ë©´ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.
""")

# --- ê·œì¹™ ì„¤ëª… ---
rule_details = {
    "ê¸°ë³¸ ê·œì¹™": "ì´ì „ ë‹¨ì–´ì˜ ë§ˆì§€ë§‰ ê¸€ìë¡œë§Œ ì‹œì‘í•´ì•¼ í•˜ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤. (ì˜ˆ: ì‚¬ê³¼ -> ê³¼ì)",
    "í‘œì¤€ ë‘ìŒë²•ì¹™": "ê°€ì¥ ì¼ë°˜ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤. 'ã„´' ë˜ëŠ” 'ã„¹'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ë¥¼ 'ã…‡'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì „ëµ -> ì—­ì‚¬, ì€ë‹‰ -> ìµëª…)",
    "ë³€ì¹™ ê·œì¹™ ('ã„¹', 'ã„´' -> 'ã…‡')": "ì´ ê²Œì„ë§Œì˜ íŠ¹ë³„ ê·œì¹™ì…ë‹ˆë‹¤. 'ã„¹'ì´ë‚˜ 'ã„´'ìœ¼ë¡œ ëë‚˜ëŠ” ë‹¨ì–´ ë’¤ì— 'ã…‡'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: ë¯¸ì‚¬ì¼ -> ì—­ì‚¬, ë¼ë©´ -> ì—°í•„)"
}

# --- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (AIì˜ ë‘ë‡Œ ì—­í• ) ---
system_prompts = {
    "ê¸°ë³¸ ê·œì¹™": (
        "ë‹¹ì‹ ì€ 'ê¸°ë³¸ ê·œì¹™'ì„ ë”°ë¥´ëŠ” í•œêµ­ì–´ ëë§ì‡ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ê·œì¹™ì„ ë§¤ìš° ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”:\n\n"
        "1. **ê·œì¹™**: ì´ì „ ë‹¨ì–´ì˜ ë§ˆì§€ë§‰ ê¸€ìë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. ë‘ìŒë²•ì¹™ì´ë‚˜ ì–´ë– í•œ ë³€ì¹™ ê·œì¹™ë„ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
        "2. **ë‹¨ì–´ ê²€ì¦**: ë‹¹ì‹ ê³¼ ì‚¬ìš©ì ëª¨ë‘ ì‹¤ì œë¡œ ì‚¬ì „ì— ë“±ì¬ëœ ìœ íš¨í•œ í•œêµ­ì–´ ëª…ì‚¬ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. (ë‘ ê¸€ì ì´ìƒ, ì‹ ì¡°ì–´/ê³ ìœ ëª…ì‚¬ ê¸ˆì§€)\n"
        "3. **ê²Œì„ ì§„í–‰**: ì‘ë‹µì€ ì˜¤ì§ 'ë‹¤ìŒ ë‹¨ì–´' ë˜ëŠ” 'íŒ¨ë°°/ìŠ¹ë¦¬ ì„ ì–¸'ë§Œ ê°„ê²°í•˜ê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. ê·œì¹™ ì„¤ëª… ë“± ë¶ˆí•„ìš”í•œ ë§ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”.\n"
        "4. **íŒ¨ë°° íŒì •**: ì‚¬ìš©ìê°€ ê·œì¹™ì„ ì–´ê¸°ë©´(ì—†ëŠ” ë‹¨ì–´, ì˜ëª»ëœ ì‹œì‘ ê¸€ì ë“±) ì¦‰ì‹œ íŒ¨ë°°ë¥¼ ì„ ì–¸í•˜ê³  ëª…í™•í•œ ì´ìœ ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."
    ),
    "í‘œì¤€ ë‘ìŒë²•ì¹™": (
        "ë‹¹ì‹ ì€ 'í‘œì¤€ ë‘ìŒë²•ì¹™'ì„ ë”°ë¥´ëŠ” í•œêµ­ì–´ ëë§ì‡ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ê·œì¹™ì„ ë§¤ìš° ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”:\n\n"
        "1. **í‘œì¤€ ë‘ìŒë²•ì¹™**: í•œììŒ 'ëƒ, ë…€, ë‡¨, ë‰´, ë‹ˆ' ë˜ëŠ” 'ë´, ë ¤, ë¡€, ë£Œ, ë¥˜, ë¦¬'ë¡œ ëë‚˜ëŠ” ë‹¨ì–´ ë’¤ì—ëŠ” ê°ê° 'ì•¼, ì—¬, ìš”, ìœ , ì´'ë¡œ ì‹œì‘í•˜ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì „ëµ -> ì—­ì‚¬, ì€ë‹‰ -> ìµëª…) ë‹¹ì‹ ë„ ì´ ê·œì¹™ì„ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
        "2. **ë‹¨ì–´ ê²€ì¦**: ë‹¹ì‹ ê³¼ ì‚¬ìš©ì ëª¨ë‘ ì‹¤ì œë¡œ ì‚¬ì „ì— ë“±ì¬ëœ ìœ íš¨í•œ í•œêµ­ì–´ ëª…ì‚¬ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. (ë‘ ê¸€ì ì´ìƒ, ì‹ ì¡°ì–´/ê³ ìœ ëª…ì‚¬ ê¸ˆì§€)\n"
        "3. **ê²Œì„ ì§„í–‰**: ì‘ë‹µì€ ì˜¤ì§ 'ë‹¤ìŒ ë‹¨ì–´' ë˜ëŠ” 'íŒ¨ë°°/ìŠ¹ë¦¬ ì„ ì–¸'ë§Œ ê°„ê²°í•˜ê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. ê·œì¹™ ì„¤ëª… ë“± ë¶ˆí•„ìš”í•œ ë§ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”.\n"
        "4. **íŒ¨ë°° íŒì •**: ì‚¬ìš©ìê°€ ê·œì¹™ì„ ì–´ê¸°ë©´(ì—†ëŠ” ë‹¨ì–´, ì˜ëª»ëœ ì‹œì‘ ê¸€ì ë“±) ì¦‰ì‹œ íŒ¨ë°°ë¥¼ ì„ ì–¸í•˜ê³  ëª…í™•í•œ ì´ìœ ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."
    ),
    "ë³€ì¹™ ê·œì¹™ ('ã„¹', 'ã„´' -> 'ã…‡')": (
        "ë‹¹ì‹ ì€ 'ë³€ì¹™ ê·œì¹™'ì„ ë”°ë¥´ëŠ” í•œêµ­ì–´ ëë§ì‡ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ê·œì¹™ì„ ë§¤ìš° ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”:\n\n"
        "1. **ë§¤ìš° ì¤‘ìš”í•œ ë³€ì¹™ ê·œì¹™**: ì´ì „ ë‹¨ì–´ê°€ 'ã„¹' ë˜ëŠ” 'ã„´'ìœ¼ë¡œ ëë‚˜ëŠ” ê²½ìš°, ë‹¤ìŒ ë‹¨ì–´ëŠ” ì›ë˜ ê¸€ì ë˜ëŠ” 'ã…‡' ë‘˜ ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: 'ë¯¸ì‚¬ì¼' ë’¤ì—ëŠ” 'ì¼ìš”ì¼' ë˜ëŠ” 'ì—­ì‚¬' ëª¨ë‘ ì •ë‹µ / 'ë¼ë©´' ë’¤ì—ëŠ” 'ë©´ë„ê¸°' ë˜ëŠ” 'ì—°í•„' ëª¨ë‘ ì •ë‹µ) ì´ê²ƒì€ ì´ ê²Œì„ë§Œì˜ íŠ¹ë³„ ê·œì¹™ì…ë‹ˆë‹¤.\n"
        "2. **ë‹¨ì–´ ê²€ì¦**: ë‹¹ì‹ ê³¼ ì‚¬ìš©ì ëª¨ë‘ ì‹¤ì œë¡œ ì‚¬ì „ì— ë“±ì¬ëœ ìœ íš¨í•œ í•œêµ­ì–´ ëª…ì‚¬ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. (ë‘ ê¸€ì ì´ìƒ, ì‹ ì¡°ì–´/ê³ ìœ ëª…ì‚¬ ê¸ˆì§€)\n"
        "3. **ê²Œì„ ì§„í–‰**: ì‘ë‹µì€ ì˜¤ì§ 'ë‹¤ìŒ ë‹¨ì–´' ë˜ëŠ” 'íŒ¨ë°°/ìŠ¹ë¦¬ ì„ ì–¸'ë§Œ ê°„ê²°í•˜ê²Œ í•´ì•¼ í•©ë‹ˆë‹¤. ê·œì¹™ ì„¤ëª… ë“± ë¶ˆí•„ìš”í•œ ë§ì€ ì ˆëŒ€ í•˜ì§€ ë§ˆì„¸ìš”.\n"
        "4. **íŒ¨ë°° íŒì •**: ì‚¬ìš©ìê°€ ê·œì¹™ì„ ì–´ê¸°ë©´(ì—†ëŠ” ë‹¨ì–´, ì˜ëª»ëœ ì‹œì‘ ê¸€ì ë“±) ì¦‰ì‹œ íŒ¨ë°°ë¥¼ ì„ ì–¸í•˜ê³  ëª…í™•í•œ ì´ìœ ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”."
    )
}


# --- ì‚¬ì´ë“œë°” ---
with st.sidebar:
    st.header("âš™ï¸ ê²Œì„ ì„¤ì •")
    
    # ê·œì¹™ ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼
    selected_rule = st.radio(
        "ê·œì¹™ì„ ì„ íƒí•˜ì„¸ìš”:",
        options=list(rule_details.keys()),
        captions=list(rule_details.values())
    )

    # API í‚¤ ì…ë ¥
    openai_api_key = st.text_input("OpenAI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”", type="password")
    st.markdown("[API í‚¤ ë°œê¸‰ë°›ëŠ” ë°©ë²• ì•Œì•„ë³´ê¸°](https://platform.openai.com/account/api-keys)")

    # ìƒˆ ê²Œì„ ì‹œì‘ ë²„íŠ¼
    if st.button("ìƒˆ ê²Œì„ ì‹œì‘í•˜ê¸°"):
        start_words = ["ë°”ë‚˜ë‚˜", "ì‚¬ê³¼", "ê¸°ì°¨", "ë‚˜ë¬´", "í•™êµ", "ì»´í“¨í„°", "ê°•ì•„ì§€", "ì‚¬ë‘", "ìš°ìœ ", "ë¼ë©´", "ë¡œì¼“", "ì¥ë‚œê°"]
        random_word = random.choice(start_words)
        
        # ì„ íƒëœ ê·œì¹™ê³¼ ì‹œì‘ ë‹¨ì–´ë¡œ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
        st.session_state.selected_rule = selected_rule
        st.session_state.messages = [
            {"role": "assistant", "content": f"ì•ˆë…•í•˜ì„¸ìš”! [{selected_rule}]ìœ¼ë¡œ ëë§ì‡ê¸° ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì €ë¶€í„° ì‹œì‘í• ê²Œìš”. **{random_word}**"}
        ]
        st.rerun()

# --- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ---
if "messages" not in st.session_state:
    st.session_state.selected_rule = "ê¸°ë³¸ ê·œì¹™"
    st.session_state.messages = [
        {"role": "assistant", "content": f"ì•ˆë…•í•˜ì„¸ìš”! ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ ê·œì¹™ì„ ì„ íƒí•˜ê³  API í‚¤ë¥¼ ì…ë ¥í•œ ë’¤ 'ìƒˆ ê²Œì„ ì‹œì‘í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”."}
    ]

# --- ë©”ì¸ í™”ë©´ ---
st.info(f"í˜„ì¬ ì ìš© ì¤‘ì¸ ê·œì¹™: **{st.session_state.selected_rule}**")

# API í‚¤ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ì•ˆë‚´
if not openai_api_key:
    st.warning("ì™¼ìª½ ì‚¬ì´ë“œë°”ì—ì„œ OpenAI API í‚¤ë¥¼ ì…ë ¥í•˜ì‹œë©´ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")
else:
    # ëŒ€í™” ê¸°ë¡ í‘œì‹œ
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
    prompt = st.chat_input("ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...")
    if prompt:
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        try:
            client = OpenAI(api_key=openai_api_key)
            
            # í˜„ì¬ ì„ íƒëœ ê·œì¹™ì— ë§ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ê°€ì ¸ì˜´
            system_prompt = system_prompts[st.session_state.selected_rule]
            
            with st.chat_message("assistant"):
                with st.spinner("AIê°€ ë‹¨ì–´ë¥¼ ê²€ì¦í•˜ê³  ìƒê°í•˜ê³  ìˆì–´ìš”..."):
                    
                    messages_for_api = [{"role": "system", "content": system_prompt}] + st.session_state.messages
                    
                    stream = client.chat.completions.create(
                        model="gpt-4o-mini",
                        messages=messages_for_api,
                        stream=True,
                    )
                    response = st.write_stream(stream)
            
            st.session_state.messages.append({"role": "assistant", "content": response})
            st.rerun() # AI ì‘ë‹µ í›„ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ê¹”ë”í•˜ê²Œ í‘œì‹œ

        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            st.session_state.messages.pop() # ì˜¤ë¥˜ ë°œìƒ ì‹œ ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ì œê±°